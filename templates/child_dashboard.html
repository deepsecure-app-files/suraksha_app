<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suraksha Child</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="preload" as="image" href="{{ profile_pic_url or url_for('static', filename='default-profile.png') }}">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap');

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        body { 
            background-color: #f0f2f5; height: 100vh; display: flex; flex-direction: column; overflow: hidden; 
        }

        /* --- HEADER --- */
        .header {
            background: #1877F2; color: white; padding: 10px 15px;
            display: flex; align-items: center; justify-content: space-between;
            height: 60px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); z-index: 1000;
        }
        .logo { font-size: 1.4rem; font-weight: bold; }
        .battery-status { font-size: 0.9rem; display: flex; align-items: center; gap: 5px; background: rgba(0,0,0,0.2); padding: 4px 10px; border-radius: 20px;}

        /* --- MAP --- */
        #map { flex: 1; width: 100%; z-index: 1; }

        /* --- SOS BUTTON --- */
        .sos-container {
            position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%);
            z-index: 2000; display: flex; flex-direction: column; align-items: center;
        }
        .sos-btn {
            width: 70px; height: 70px; background: #dc2626; color: white;
            border-radius: 50%; border: 4px solid rgba(255,255,255,0.3);
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem; box-shadow: 0 4px 15px rgba(220, 38, 38, 0.4);
            cursor: pointer; animation: pulse 2s infinite;
        }
        .sos-label { margin-top: 5px; color: #dc2626; font-weight: bold; font-size: 0.8rem; background: rgba(255,255,255,0.9); padding: 2px 8px; border-radius: 10px; }

        @keyframes pulse { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.7); } 70% { transform: scale(1.1); box-shadow: 0 0 0 15px rgba(220, 38, 38, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(220, 38, 38, 0); } }

        /* --- BOTTOM TABS --- */
        .bottom-tabs {
            height: 60px; background: white; display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #ddd; z-index: 1000;
        }
        .tab { display: flex; flex-direction: column; align-items: center; color: #65676b; font-size: 0.75rem; text-decoration: none; }
        .tab i { font-size: 1.4rem; margin-bottom: 2px; }
        .tab.active { color: #1877F2; }

        /* --- ðŸ”¥ PAIRING SCREEN (MISSING PART RESTORED) --- */
        .pairing-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #f0f2f5; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 20px;
        }
        .pair-card {
            background: white; padding: 30px; border-radius: 15px;
            width: 100%; max-width: 350px; text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .pair-icon { font-size: 3rem; color: #1877F2; margin-bottom: 20px; }
        .pair-input {
            width: 100%; padding: 12px; margin: 20px 0; border: 1px solid #ddd;
            border-radius: 8px; font-size: 1.2rem; text-align: center; letter-spacing: 2px;
            text-transform: uppercase;
        }
        .pair-btn {
            background: #1877F2; color: white; border: none; padding: 12px;
            width: 100%; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer;
        }
        
        #child_file_input { display: none; }
    </style>
</head>
<body>

    {% if not parent %}
    <div class="pairing-overlay">
        <div class="pair-card">
            <i class="fa-solid fa-link pair-icon"></i>
            <h2 style="color:#1c1e21; margin-bottom:10px;">Connect Parent</h2>
            <p style="color:#65676b; font-size:0.9rem;">Enter the pairing code from parent's app to link this device.</p>
            
            <form action="{{ url_for('pair_device') }}" method="POST">
                <input type="text" name="pairing_code" class="pair-input" placeholder="ENTER CODE" required>
                <button type="submit" class="pair-btn">Connect Now</button>
            </form>
            
            <a href="{{ url_for('logout') }}" style="display:block; margin-top:20px; color:#dc2626; text-decoration:none; font-size:0.9rem;">Logout</a>
        </div>
    </div>
    {% endif %}

    <div class="header">
        <div class="logo">suraksha</div>
        <div class="battery-status"><i class="fa-solid fa-battery-three-quarters"></i> <span id="bat-level">--%</span></div>
    </div>

    <div id="map"></div>

    <div class="sos-container">
        <div class="sos-btn" id="sosBtn" onclick="toggleSOS()">
            <i class="fa-solid fa-bell"></i>
        </div>
        <div class="sos-label">SOS</div>
    </div>

    <div class="bottom-tabs">
        <a href="#" class="tab active"><i class="fa-solid fa-map-location-dot"></i> Home</a>
        <div class="tab" onclick="document.getElementById('child_file_input').click()">
            <img src="{{ profile_pic_url or url_for('static', filename='default-profile.png') }}" style="width:28px; height:28px; border-radius:50%; object-fit:cover; border:2px solid #ddd;">
            <span>Profile</span>
        </div>
        <a href="{{ url_for('logout') }}" class="tab" style="color:#dc2626;"><i class="fa-solid fa-power-off"></i> Exit</a>
    </div>

    <form id="profileForm" action="{{ url_for('upload_profile_pic') }}" method="POST" enctype="multipart/form-data">
        <input type="file" name="profile_pic" id="child_file_input" accept="image/*" onchange="document.getElementById('profileForm').submit()">
    </form>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // --- 1. Map Setup ---
        var map = L.map('map', { zoomControl: false }).setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] }).addTo(map);
        var marker = null;

        // --- 2. SOS Logic ---
        var isSOS = false;
        function toggleSOS() {
            isSOS = !isSOS;
            var btn = document.getElementById('sosBtn');
            if (isSOS) {
                btn.style.background = "white"; btn.style.color = "red";
                alert("SOS ALERT SENT TO PARENT!");
            } else {
                btn.style.background = "#dc2626"; btn.style.color = "white";
            }
            sendLocation(true); // Turant update bhejo
        }

        // --- 3. Location & Battery Sync ---
        function sendLocation(immediate=false) {
            if (!navigator.geolocation) return;
            navigator.geolocation.getCurrentPosition(position => {
                var lat = position.coords.latitude;
                var lng = position.coords.longitude;

                if (marker) marker.setLatLng([lat, lng]);
                else {
                    var icon = L.divIcon({ className: 'c-div', html: '<div style="width:15px;height:15px;background:#1877F2;border:2px solid white;border-radius:50%;"></div>' });
                    marker = L.marker([lat, lng], {icon: icon}).addTo(map);
                    map.setView([lat, lng], 17);
                }

                // API Call to Update Server
                fetch('/api/update_location', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        latitude: lat,
                        longitude: lng,
                        is_sos: isSOS // SOS status bhi bhej rahe hain
                    })
                });

            }, err => console.log(err), { enableHighAccuracy: true });
        }

        // Battery Status
        navigator.getBattery().then(function(battery) {
            function updateBattery() { document.getElementById('bat-level').innerText = Math.round(battery.level * 100) + "%"; }
            updateBattery();
            battery.addEventListener('levelchange', updateBattery);
        });

        setInterval(sendLocation, 5000);
        sendLocation();
    </script>
</body>
</html>

