<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suraksha OneView</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="preload" as="image" href="{{ profile_pic_url or url_for('static', filename='default-profile.png') }}">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap');

        * { 
            margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea { -webkit-user-select: text !important; user-select: text !important; }

        html, body { 
            background-color: #f0f2f5; 
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            overflow: hidden; position: fixed;
        }

        /* --- 1. HEADER (Perfected) --- */
        .header {
            background: linear-gradient(135deg, #0f172a, #1e293b);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 80px; /* ‡§π‡•á‡§°‡§∞ ‡§ï‡•Ä ‡§ä‡§Ç‡§ö‡§æ‡§à ‡§´‡§ø‡§ï‡•ç‡§∏ ‡§ï‡•Ä */
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
            z-index: 2001;
            flex-shrink: 0;
        }

        /* ‡§Æ‡•á‡§®‡•Ç ‡§¨‡§ü‡§® */
        .menu-btn { color: white; font-size: 1.6rem; cursor: pointer; padding: 5px; }

        /* üî• ‡§∏‡•Å‡§ß‡§æ‡§∞ 1: 'suraksha' ‡§¨‡•ç‡§∞‡§æ‡§Ç‡§° ‡§¨‡•Ä‡§ö ‡§Æ‡•á‡§Ç ‡§î‡§∞ ‡§∏‡•Å‡§®‡§π‡§∞‡§æ */
        .app-brand {
            font-size: 1.8rem;
            font-weight: 900;
            background: linear-gradient(to right, #FFD700, #FDB931, #FFD700);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 2px 10px rgba(255, 215, 0, 0.3);
            letter-spacing: -0.5px;
            text-transform: lowercase;
        }

        /* üî• ‡§∏‡•Å‡§ß‡§æ‡§∞ 2: ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§´‡•ã‡§ü‡•ã ‡§¨‡§°‡§º‡•Ä ‡§î‡§∞ ‡§∏‡§æ‡§á‡§° ‡§Æ‡•á‡§Ç */
        .header-profile-box {
            position: relative;
            cursor: pointer;
        }
        .parent-img-large {
            width: 52px; height: 52px; /* ‡§∏‡§æ‡§á‡§ú‡§º ‡§¨‡§°‡§º‡§æ ‡§ï‡§ø‡§Ø‡§æ */
            border-radius: 50%;
            border: 3px solid #FFD700; /* ‡§ó‡•ã‡§≤‡•ç‡§°‡§® ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ */
            object-fit: cover;
            background-color: #334155;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .parent-img-large:active { transform: scale(0.95); }

        /* --- 2. SIDE MENU (Children List Inside) --- */
        .side-menu {
            position: absolute; top: 0; left: -320px; width: 300px; height: 100%;
            background: white; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            z-index: 3000; display: flex; flex-direction: column;
            box-shadow: 100px 0 0 rgba(0,0,0,0.5); /* ‡§¨‡§æ‡§π‡§∞ ‡§ï‡§æ ‡§π‡§ø‡§∏‡•ç‡§∏‡§æ ‡§ï‡§æ‡§≤‡§æ ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
        }
        .side-menu.open { left: 0; }
        
        .menu-header { 
            background: #0f172a; padding: 30px 20px; color: white; 
            border-bottom: 4px solid #FFD700;
        }
        .menu-user-name { font-size: 1.4rem; font-weight: bold; margin-bottom: 5px; }
        .menu-user-role { font-size: 0.9rem; color: #cbd5e1; }

        .children-section { flex: 1; overflow-y: auto; padding: 15px; background: #f8fafc; }
        .section-label { font-size: 0.85rem; font-weight: 700; color: #64748b; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }

        /* ‡§Æ‡•á‡§®‡•Ç ‡§ï‡•á ‡§Ö‡§Ç‡§¶‡§∞ ‡§¨‡§ö‡•ç‡§ö‡•á ‡§ï‡§æ ‡§ï‡§æ‡§∞‡•ç‡§° */
        .menu-child-card {
            background: white; border-radius: 12px; padding: 12px;
            margin-bottom: 10px; display: flex; align-items: center; gap: 12px;
            border: 1px solid #e2e8f0; box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            transition: 0.2s;
        }
        .menu-child-card:active { background: #eef2ff; border-color: #1877F2; }
        
        .menu-child-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; }
        .menu-child-info h4 { font-size: 1rem; color: #0f172a; margin-bottom: 2px; }
        .menu-child-status { font-size: 0.8rem; color: #64748b; }
        .live-badge { color: #10b981; font-weight: bold; font-size: 0.75rem; display: flex; align-items: center; gap: 4px; margin-left: auto; }
        .live-dot { width: 8px; height: 8px; background: #10b981; border-radius: 50%; }

        .add-child-btn {
            width: 100%; padding: 12px; background: white; border: 2px dashed #cbd5e1;
            border-radius: 12px; color: #64748b; font-weight: 600; cursor: pointer;
            margin-top: 10px; text-align: center;
        }

        .logout-btn {
            margin: 20px; padding: 15px; background: #fee2e2; color: #ef4444;
            text-align: center; border-radius: 12px; text-decoration: none; font-weight: bold;
            display: block;
        }

        /* --- 3. MAP CONTAINER (Adjusted Size) --- */
        .map-wrapper {
            flex: 1; 
            position: relative; 
            width: 100%;
            /* üî• ‡§∏‡•Å‡§ß‡§æ‡§∞ 3: ‡§Æ‡•à‡§™ ‡§ï‡•ã ‡§•‡•ã‡§°‡§º‡§æ ‡§¶‡§¨‡§æ‡§Ø‡§æ ‡§§‡§æ‡§ï‡§ø ‡§π‡•á‡§°‡§∞ ‡§∏‡§æ‡§´ ‡§¶‡§ø‡§ñ‡•á */
            margin-top: -15px; 
            padding-bottom: 70px; /* ‡§´‡•Å‡§ü‡§∞ ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§ó‡§π */
            z-index: 1;
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            overflow: hidden;
            background: white; /* ‡§ï‡•ã‡§®‡•ã‡§Ç ‡§™‡§∞ ‡§∏‡§´‡§º‡•á‡§¶ ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ */
        }
        #map { width: 100%; height: 100%; }

        /* --- 4. BOTTOM NAV --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%);
            width: 90%; max-width: 400px; height: 65px;
            background: white; border-radius: 20px;
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
            z-index: 2000;
        }
        .nav-item { color: #94a3b8; font-size: 1.5rem; position: relative; }
        .nav-item.active { color: #1877F2; }
        .nav-item.active::after {
            content: ''; position: absolute; bottom: -8px; left: 50%; transform: translateX(-50%);
            width: 5px; height: 5px; background: #1877F2; border-radius: 50%;
        }

        /* SOS Alert */
        #sos-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(220, 38, 38, 0.95); z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center; color: white;
            text-align: center; padding: 20px;
        }
        .sos-btn-stop { background: white; color: #dc2626; padding: 15px 30px; border-radius: 50px; border: none; font-weight: bold; font-size: 1.2rem; margin-top: 30px; }

        /* Hidden Input */
        #parent_file_input { display: none; }
        
        /* Map Markers */
        .child-marker-icon { width: 50px; height: 50px; border-radius: 50%; border: 3px solid white; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    </style>
</head>
<body>

    <div id="sos-overlay">
        <i class="fa-solid fa-triangle-exclamation" style="font-size: 5rem; animation: pulse 0.5s infinite;"></i>
        <h1 style="font-size: 2.5rem; margin-top: 20px;">SOS ALERT!</h1>
        <p id="sos-text" style="font-size: 1.2rem;">Emergency reported.</p>
        <button class="sos-btn-stop" onclick="dismissSOS()">I AM SAFE</button>
    </div>

    <div class="header">
        <i class="fa-solid fa-bars menu-btn" onclick="toggleMenu()"></i>
        <div class="app-brand">suraksha</div>
        <div class="header-profile-box" onclick="document.getElementById('parent_file_input').click()">
            <img src="{{ profile_pic_url or url_for('static', filename='default-profile.png') }}" class="parent-img-large">
        </div>
    </div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="menu-user-name">{{ username }}</div>
            <div class="menu-user-role">Premium Parent Account</div>
        </div>

        <div class="children-section">
            <div class="section-label">My Family</div>
            
            {% if children %}
                {% for child in children %}
                <div class="menu-child-card" onclick="locateChild('{{ child.last_latitude }}', '{{ child.last_longitude }}')">
                    <img src="{{ child.profile_pic if child.profile_pic else url_for('static', filename='default-profile.png') }}" class="menu-child-img">
                    <div class="menu-child-info">
                        <h4>{{ child.name }}</h4>
                        <div class="menu-child-status" id="status-{{ child.id }}">Updating...</div>
                    </div>
                    <div class="live-badge"><div class="live-dot"></div> Live</div>
                </div>
                {% endfor %}
            {% else %}
                <p style="text-align:center; color:#94a3b8; padding:20px;">No children added.</p>
            {% endif %}

            <form action="{{ url_for('add_child') }}" method="POST" style="margin-top:10px;">
                <input type="text" name="child_name" placeholder="Enter child name..." style="width:100%; padding:10px; border:1px solid #ddd; border-radius:8px; margin-bottom:5px;" required>
                <button type="submit" class="add-child-btn"><i class="fa-solid fa-plus"></i> Add New Child</button>
            </form>
        </div>

        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
    </div>

    <div class="map-wrapper">
        <div id="map"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="location.reload()"><i class="fa-solid fa-map-location-dot"></i></div>
        <div class="nav-item" onclick="window.location.href='{{ url_for('geofence_page') }}'"><i class="fa-solid fa-shield-halved"></i></div>
        <div class="nav-item" onclick="toggleMenu()"><i class="fa-solid fa-gear"></i></div>
    </div>

    <form id="profileForm" action="{{ url_for('upload_profile_pic') }}" method="POST" enctype="multipart/form-data">
        <input type="file" name="profile_pic" id="parent_file_input" accept="image/*" onchange="document.getElementById('profileForm').submit()">
    </form>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // --- Working Map & JS Logic ---
        var map = L.map('map', { zoomControl: false }).setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map);

        var markers = {};
        var siren = new Audio('https://www.soundjay.com/buttons/sounds/alarm-siren-01.mp3');

        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('open');
        }

        // ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§™‡§∞ ‡§ï‡§π‡•Ä‡§Ç ‡§≠‡•Ä ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§®‡•á ‡§™‡§∞ ‡§Æ‡•á‡§®‡•Ç ‡§¨‡§Ç‡§¶ (Menu ‡§ï‡•á ‡§¨‡§æ‡§π‡§∞)
        document.getElementById('map').onclick = function() {
            document.getElementById('sideMenu').classList.remove('open');
        }

        function locateChild(lat, lng) {
            if (lat && lat !== 'None') {
                map.setView([lat, lng], 18);
                toggleMenu(); // ‡§ï‡§æ‡§∞‡•ç‡§° ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡§§‡•á ‡§π‡•Ä ‡§Æ‡•á‡§®‡•Ç ‡§¨‡§Ç‡§¶ ‡§î‡§∞ ‡§Æ‡•à‡§™ ‡§¶‡§ø‡§ñ‡•á‡§ó‡§æ
            } else {
                alert("Location not available yet.");
            }
        }

        function dismissSOS() {
            document.getElementById('sos-overlay').style.display = 'none';
            siren.pause();
            siren.currentTime = 0;
        }

        function updateData() {
            fetch('/api/get_children_data')
                .then(res => res.json())
                .then(data => {
                    data.children.forEach(child => {
                        if (child.last_latitude) {
                            var lat = child.last_latitude;
                            var lng = child.last_longitude;

                            // Update Marker
                            var icon = L.divIcon({
                                className: 'custom-div',
                                html: `<img src="${child.profile_pic || '/static/default-profile.png'}" class="child-marker-icon">`,
                                iconSize: [50, 50], iconAnchor: [25, 25]
                            });

                            if (markers[child.id]) {
                                markers[child.id].setLatLng([lat, lng]);
                            } else {
                                markers[child.id] = L.marker([lat, lng], {icon: icon}).addTo(map);
                            }

                            // SOS Check
                            if (child.is_sos) {
                                var overlay = document.getElementById('sos-overlay');
                                if (overlay.style.display !== 'flex') {
                                    overlay.style.display = 'flex';
                                    document.getElementById('sos-text').innerText = child.name + " needs help!";
                                    siren.play().catch(e => console.log(e));
                                }
                            }
                            
                            // Menu Status Update
                            var st = document.getElementById('status-' + child.id);
                            if(st) st.innerText = "Active Now";
                        }
                    });
                });
        }
        
        setInterval(updateData, 5000);
        updateData();
    </script>
</body>
</html>
