<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suraksha OneView</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap');

        /* --- 1. GLOBAL STYLES --- */
        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        input, textarea { -webkit-user-select: text !important; user-select: text !important; }
        html, body { background-color: #f0f2f5; height: 100%; width: 100%; display: flex; flex-direction: column; overflow: hidden; position: fixed; }

        /* --- 2. HEADER --- */
        .header {
            background: #1877F2; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            height: 65px; z-index: 2001; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .header-left { flex: 1; display: flex; align-items: center; gap: 10px; }
        .parent-img-large {
            width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; 
            object-fit: cover; background-color: white; cursor: pointer;
        }
        .app-brand { font-size: 1.5rem; font-weight: 800; color: white; letter-spacing: 0.5px; }
        .menu-btn { color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; }

        /* --- 3. SIDE MENU (Child List) --- */
        .side-menu {
            position: absolute; top: 0; left: -320px; width: 300px; height: 100%;
            background: white; transition: 0.3s ease-in-out; z-index: 3000; 
            display: flex; flex-direction: column; box-shadow: 10px 0 20px rgba(0,0,0,0.3);
            /* ✨ FIX: Logout Button Space - नीचे से जगह छोड़ें ताकि बटन न लड़ें ✨ */
            padding-bottom: 80px; 
        }
        .side-menu.open { left: 0; }
        
        .menu-header { 
            background: #1877F2; padding: 25px; color: white; 
            text-align: center;
        }
        .menu-user-name { font-size: 1.2rem; font-weight: bold; margin-top: 5px; }

        .children-section { flex: 1; overflow-y: auto; padding: 10px; background: #f0f2f5; }

        /* Child Card Design */
        .menu-child-card {
            background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 12px; border: 1px solid #e1e4e8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; position: relative;
        }
        .menu-child-card:active { background: #f8fafc; }
        .menu-child-img { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 2px solid #d4af37; background: #eee; }
        .menu-child-info { flex: 1; }
        
        .child-name-gold { color: #b45309; font-weight: 900; font-size: 1.1rem; text-transform: capitalize; margin-bottom: 2px; }
        .child-id { font-size: 0.75rem; color: #64748b; }

        /* Last Seen Style */
        .child-seen {
            font-size: 0.75rem; color: #64748b; margin-top: 4px; margin-bottom: 4px;
            font-weight: 500; display: flex; align-items: center; gap: 5px;
        }

        .status-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        
        /* Badges */
        .dist-badge { 
            font-size: 0.8rem; color: #1877F2; font-weight: bold; 
            background: #e7f3ff; padding: 4px 10px; border-radius: 15px; 
            display: flex; align-items: center; gap: 5px;
        }
        .bat-badge { font-size: 0.8rem; font-weight: bold; padding: 4px 10px; border-radius: 15px; display: flex; align-items: center; gap: 5px; }
        .bat-high { color: #16a34a; background: #dcfce7; } /* Green */
        .bat-low { color: #dc2626; background: #fee2e2; }   /* Red */

        /* --- 4. MAP AREA & AD SPACE --- */
        .ad-container-middle {
            width: 100%; height: 60px; background-color: #e5e7eb;
            display: flex; justify-content: center; align-items: center;
            flex-shrink: 0; color: #9ca3af; font-size: 0.8rem; border-bottom: 1px solid #d1d5db;
        }

        .map-wrapper { flex: 1; position: relative; width: 100%; margin-bottom: 80px; background: #e5e7eb; }
        #map { width: 100%; height: 100%; }
        .leaflet-control-attribution { display: none !important; }

        /* --- 5. BOTTOM NAVIGATION --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px; padding-bottom: 20px; background: white;
            display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 2000;
        }
        .nav-item { color: #94a3b8; font-size: 1.4rem; height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .nav-item.active { color: #1877F2; border-top: 3px solid #1877F2; }

        /* --- 6. SOS OVERLAY --- */
        #sos-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(220, 38, 38, 0.98); z-index: 9999; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center; padding: 20px;
        }
        .sos-btn-stop { background: white; color: #dc2626; padding: 15px 40px; border-radius: 50px; border: none; font-weight: bold; font-size: 1.2rem; margin-top: 30px; cursor: pointer; }

        /* --- 7. TOAST NOTIFICATION --- */
        #toast {
            visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff;
            text-align: center; border-radius: 50px; padding: 14px; position: fixed; z-index: 5000;
            left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 0.95rem; font-weight: 500;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 100px; }
        
        /* Map Markers */
        #parent_file_input { display: none; }
        .child-marker-icon { width: 45px; height: 45px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); object-fit: cover; background: #fff; }
        .parent-dot { width: 18px; height: 18px; background: #1877F2; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 15px rgba(24, 119, 242, 0.6); }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="toast">Initializing...</div>

    <div id="sos-overlay">
        <i class="fa-solid fa-triangle-exclamation" style="font-size: 5rem; animation: pulse 0.5s infinite;"></i>
        <h1 style="font-size: 2.5rem; margin-top: 20px;">SOS ALERT!</h1>
        <p id="sos-text" style="font-size: 1.5rem; font-weight: bold;">Child needs help!</p>
        <button class="sos-btn-stop" onclick="dismissSOS()">I AM SAFE (STOP)</button>
    </div>

    <div class="header">
        <div class="header-left">
            <img src="{{ profile_pic_url or url_for('static', filename='default-profile.png') }}" 
                 class="parent-img-large" 
                 onclick="document.getElementById('parent_file_input').click()"
                 onerror="this.src='{{ url_for('static', filename='default-profile.png') }}'">
            <div class="app-brand">Suraksha</div>
        </div>
        <div class="header-right">
            <i class="fa-solid fa-bars menu-btn" onclick="toggleMenu()"></i>
        </div>
    </div>

    <div class="ad-container-middle">
        <p>Advertisement Space</p>
    </div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div style="font-size: 1.8rem; font-weight: 900;">Suraksha</div>
            <div class="menu-user-name">Hello, {{ username }}</div>
        </div>

        <div class="children-section">
            {% if children %}
                {% for child in children %}
                <div class="menu-child-card" onclick="locateChild('{{ child.last_latitude }}', '{{ child.last_longitude }}')">
                    <img src="{{ child.profile_pic if child.profile_pic else url_for('static', filename='default-profile.png') }}" class="menu-child-img" onerror="this.src='{{ url_for('static', filename='default-profile.png') }}'">
                    
                    <div class="menu-child-info">
                        <div class="child-name-gold">{{ child.name }}</div>
                        <div class="child-id">ID: {{ child.pairing_code }}</div>

                        <div class="child-seen" id="seen-{{ child.id }}">
                            <i class="fa-regular fa-clock"></i> 
                            {{ child.last_seen.strftime('%I:%M %p') if child.last_seen else 'Offline' }}
                        </div>
                        
                        <div class="status-row">
                            <div class="dist-badge" id="dist-{{ child.id }}">
                                <i class="fa-solid fa-location-arrow"></i> Wait...
                            </div>
                            <div class="bat-badge {{ 'bat-low' if ((child.last_battery or 0) < 20) else 'bat-high' }}" id="bat-{{ child.id }}">
                                <i class="fa-solid fa-battery-full"></i> {{ child.last_battery or 0 }}%
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="text-align:center; color:#94a3b8; padding:20px;">No children connected.</p>
            {% endif %}

            <div style="padding: 15px; border-top: 1px solid #eee; background: white;">
                <form action="{{ url_for('add_child') }}" method="POST">
                    <input type="text" name="child_name" placeholder="Child Name" style="width:100%; padding:12px; margin-bottom:10px; border:1px solid #ddd; border-radius:8px;" required>
                    <button type="submit" style="width: 100%; padding: 12px; background: #1877F2; color: white; border: none; border-radius: 8px; font-weight: 600;"><i class="fa-solid fa-plus"></i> Add Child</button>
                </form>
            </div>
        </div>

        <a href="{{ url_for('logout') }}" style="padding: 15px; margin-bottom: 20px; color: #dc2626; text-align: center; font-weight: bold; text-decoration: none; border-top: 1px solid #eee; display: block;">Logout</a>
    </div>

    <div class="map-wrapper"><div id="map"></div></div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="location.reload()"><i class="fa-solid fa-map-location-dot"></i></div>
        <div class="nav-item" onclick="window.location.href='{{ url_for('geofence_page') }}'"><i class="fa-solid fa-shield-halved"></i></div>
        <div class="nav-item" onclick="toggleMenu()"><i class="fa-solid fa-gear"></i></div>
    </div>

    <form id="profileForm" action="{{ url_for('upload_profile_pic') }}" method="POST" enctype="multipart/form-data">
        <input type="file" name="profile_pic" id="parent_file_input" accept="image/*" onchange="document.getElementById('profileForm').submit()">
    </form>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // 1. Map Initialization
        var map = L.map('map', { zoomControl: false }).setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] }).addTo(map);

        var markers = {}; 
        var polylines = {}; 
        var parentMarker = null; 
        var parentLat = null, parentLng = null;
        var siren = new Audio('https://www.soundjay.com/buttons/sounds/alarm-siren-01.mp3');

        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('open'); }
        document.getElementById('map').onclick = function() { document.getElementById('sideMenu').classList.remove('open'); }
        function dismissSOS() { document.getElementById('sos-overlay').style.display = 'none'; siren.pause(); siren.currentTime = 0; }

        function showToast(msg) {
            var x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        function locateChild(lat, lng) {
            if (lat && lat !== 'None' && lat !== 'null') { 
                map.setView([lat, lng], 18); 
                toggleMenu(); 
            } else { 
                showToast("⚠️ Child location not updated yet."); 
            }
        }

        // 2. FORCE PARENT GPS
        function updateParentLocation() {
            if (!navigator.geolocation) {
                showToast("❌ GPS Not Supported");
                return;
            }
            navigator.geolocation.watchPosition(position => {
                parentLat = position.coords.latitude;
                parentLng = position.coords.longitude;
                if (parentMarker) {
                    parentMarker.setLatLng([parentLat, parentLng]);
                } else {
                    var icon = L.divIcon({ className: 'p-div', html: '<div class="parent-dot"></div>', iconSize: [18, 18] });
                    parentMarker = L.marker([parentLat, parentLng], {icon: icon}).addTo(map);
                    map.setView([parentLat, parentLng], 15);
                    showToast("✅ Parent GPS Connected");
                }
            }, err => {
                console.warn("GPS Error", err);
                showToast("⚠️ Turn On GPS for Blue Line");
            }, { enableHighAccuracy: true, maximumAge: 0, timeout: 15000 });
        }
        updateParentLocation();

        // 3. MAIN DATA SYNC LOOP
        function updateData() {
            fetch('/api/get_children_data')
                .then(res => res.json())
                .then(data => {
                    data.children.forEach(child => {

                        // ✨ FIX: CORRECT TIMEZONE LOGIC (UTC to Phone Local Time) ✨
                        var seenElem = document.getElementById('seen-' + child.id);
                        if(seenElem && child.last_seen) {
                            // सर्वर का टाइम UTC में आता है, उसमें 'Z' जोड़कर JS को बता रहे हैं
                            var utcString = child.last_seen.endsWith('Z') ? child.last_seen : child.last_seen + 'Z';
                            var date = new Date(utcString);
                            // यह लाइन उसे आपके फोन के सही टाइम में बदल देगी
                            var timeStr = date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                            seenElem.innerHTML = `<i class="fa-regular fa-clock"></i> ${timeStr}`;
                        }
                        
                        // Battery Update
                        var batVal = (child.last_battery !== undefined) ? child.last_battery : 0;
                        var batElem = document.getElementById('bat-' + child.id);
                        if(batElem) {
                            batElem.innerHTML = `<i class="fa-solid fa-battery-full"></i> ${batVal}%`;
                            batElem.className = (batVal < 20) ? "bat-badge bat-low" : "bat-badge bat-high";
                        }

                        // SOS Check
                        if (child.is_sos) {
                            var overlay = document.getElementById('sos-overlay');
                            if (overlay.style.display !== 'flex') {
                                overlay.style.display = 'flex';
                                document.getElementById('sos-text').innerText = child.name + " needs help!";
                                siren.play().catch(e => console.log("Audio waiting"));
                            }
                        }

                        // Map Update
                        if (child.last_latitude && child.last_latitude !== 'None') {
                            var lat = parseFloat(child.last_latitude);
                            var lng = parseFloat(child.last_longitude);
                            var imgSrc = child.profile_pic || '/static/default-profile.png';
                            var icon = L.divIcon({
                                className: 'custom-div',
                                html: `<img src="${imgSrc}" class="child-marker-icon" onerror="this.src='/static/default-profile.png'">`,
                                iconSize: [45, 45], iconAnchor: [22, 22]
                            });

                            if (markers[child.id]) markers[child.id].setLatLng([lat, lng]);
                            else markers[child.id] = L.marker([lat, lng], {icon: icon}).addTo(map);

                            if (parentLat && parentLng) {
                                if (polylines[child.id]) map.removeLayer(polylines[child.id]);
                                polylines[child.id] = L.polyline(
                                    [[parentLat, parentLng], [lat, lng]], 
                                    { color: '#1877F2', weight: 4, opacity: 0.8, dashArray: '10, 10' }
                                ).addTo(map);
                                var p1 = L.latLng(parentLat, parentLng);
                                var p2 = L.latLng(lat, lng);
                                var d = p1.distanceTo(p2);
                                var distText = d < 1000 ? Math.round(d) + " m" : (d/1000).toFixed(1) + " km";
                                var distElem = document.getElementById('dist-' + child.id);
                                if(distElem) distElem.innerHTML = `<i class="fa-solid fa-location-arrow"></i> ${distText}`;
                            }
                        }
                    });
                });
        }
        
        setInterval(updateData, 3000);
        updateData();
    </script>
</body>
</html>
