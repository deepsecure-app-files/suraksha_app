<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suraksha OneView</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="preload" as="image" href="{{ profile_pic_url or url_for('static', filename='default-profile.png') }}">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap');

        * { -webkit-tap-highlight-color: transparent; -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; }
        input, textarea { -webkit-user-select: text !important; user-select: text !important; }

        /* ðŸ”¥ FIX: Ensure Body takes full height */
        html, body { background-color: #f0f2f5; height: 100%; width: 100%; display: flex; flex-direction: column; overflow: hidden; position: fixed; }

        /* HEADER */
        .header {
            background: #1877F2; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center;
            height: 60px; z-index: 2001; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .header-left { flex: 1; display: flex; align-items: center; }
        .parent-img-large {
            width: 40px; height: 40px; border-radius: 50%; border: 2px solid white; 
            object-fit: cover; background-color: white; cursor: pointer; pointer-events: auto;
        }
        .app-brand {
            font-size: 1.4rem; font-weight: 800; color: white; text-align: center; flex: 1; letter-spacing: 0.5px;
        }
        .header-right { flex: 1; display: flex; justify-content: flex-end; }
        .menu-btn { color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; }

        /* SIDE MENU */
        .side-menu {
            position: absolute; top: 0; left: -320px; width: 300px; height: 100%;
            background: white; transition: 0.3s ease-in-out; z-index: 3000; 
            display: flex; flex-direction: column; box-shadow: 10px 0 20px rgba(0,0,0,0.3);
        }
        .side-menu.open { left: 0; }
        
        .menu-header { 
            background: #1877F2; padding: 30px 20px; color: white; 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            text-align: center;
        }
        .menu-brand { font-size: 2rem; font-weight: 900; letter-spacing: 1px; margin-bottom: 5px; }
        .menu-user { font-size: 1.1rem; font-weight: 500; opacity: 0.9; }

        .children-section { flex: 1; overflow-y: auto; padding: 10px; background: #f0f2f5; }

        .menu-child-card {
            background: white; border-radius: 12px; padding: 12px; margin-bottom: 12px;
            display: flex; align-items: center; gap: 12px; border: 1px solid #e1e4e8;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); cursor: pointer; position: relative;
        }
        .menu-child-card:active { background: #f8fafc; }
        .menu-child-img { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; border: 2px solid #d4af37; }
        .menu-child-info { flex: 1; }
        
        /* GOLDEN NAME */
        .child-name-gold {
            color: #b45309; font-weight: 900; font-size: 1.1rem; text-transform: capitalize; margin-bottom: 2px;
        }

        .status-row { display: flex; justify-content: space-between; align-items: center; margin-top: 5px; }
        
        .dist-badge { 
            font-size: 0.8rem; color: #1877F2; font-weight: bold; 
            background: #e7f3ff; padding: 4px 10px; border-radius: 15px; 
            display: flex; align-items: center; gap: 5px;
        }
        .bat-badge { font-size: 0.8rem; font-weight: bold; padding: 4px 10px; border-radius: 15px; display: flex; align-items: center; gap: 5px; }
        .bat-high { color: #16a34a; background: #dcfce7; }
        .bat-low { color: #dc2626; background: #fee2e2; }

        /* ðŸ”¥ MAP FIX: Ensure Map takes remaining height properly */
        .map-wrapper { 
            flex-grow: 1; 
            width: 100%; 
            position: relative; 
            z-index: 1; 
            /* Fix for overlapping bottom nav */
            padding-bottom: 60px; 
        }
        #map { width: 100%; height: 100%; }
        
        .leaflet-control-attribution { display: none !important; }

        /* NAV */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px; background: white;
            display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 2000;
        }
        .nav-item { color: #94a3b8; font-size: 1.4rem; height: 100%; width: 100%; display: flex; align-items: center; justify-content: center; }
        .nav-item.active { color: #1877F2; border-top: 3px solid #1877F2; }

        /* SOS Alert */
        #sos-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(220, 38, 38, 0.95); z-index: 9999; flex-direction: column;
            align-items: center; justify-content: center; color: white; text-align: center; padding: 20px;
        }
        .sos-btn-stop { background: white; color: #dc2626; padding: 15px 40px; border-radius: 50px; border: none; font-weight: bold; font-size: 1.2rem; margin-top: 30px; }

        #toast {
            visibility: hidden; min-width: 250px; background-color: #1e293b; color: #fff;
            text-align: center; border-radius: 50px; padding: 14px; position: fixed; z-index: 5000;
            left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 0.95rem; font-weight: 500;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2); opacity: 0; transition: opacity 0.3s, bottom 0.3s;
        }
        #toast.show { visibility: visible; opacity: 1; bottom: 100px; }
        
        #parent_file_input { display: none; }
        .child-marker-icon { width: 45px; height: 45px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); object-fit: cover; background: #fff; }
        .parent-dot { width: 18px; height: 18px; background: #1877F2; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 15px rgba(24, 119, 242, 0.6); }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="toast">Message</div>

    <div id="sos-overlay">
        <i class="fa-solid fa-triangle-exclamation" style="font-size: 5rem; animation: pulse 0.5s infinite;"></i>
        <h1 style="font-size: 2.5rem; margin-top: 20px;">SOS ALERT!</h1>
        <p id="sos-text" style="font-size: 1.2rem;">Child needs help!</p>
        <button class="sos-btn-stop" onclick="dismissSOS()">I AM SAFE</button>
    </div>

    <div class="header">
        <div class="header-left" onclick="document.getElementById('parent_file_input').click()">
            <img src="{{ profile_pic_url or url_for('static', filename='default-profile.png') }}" class="parent-img-large" onerror="this.src='{{ url_for('static', filename='default-profile.png') }}'">
        </div>
        <div class="app-brand">suraksha</div>
        <div class="header-right">
            <i class="fa-solid fa-bars menu-btn" onclick="toggleMenu()"></i>
        </div>
    </div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="menu-brand">Suraksha</div>
            <div class="menu-user">Hello, {{ username }}</div>
        </div>

        <div class="children-section">
            {% if children %}
                {% for child in children %}
                <div class="menu-child-card" onclick="locateChild('{{ child.last_latitude }}', '{{ child.last_longitude }}')">
                    <img src="{{ child.profile_pic if child.profile_pic else url_for('static', filename='default-profile.png') }}" class="menu-child-img">
                    <div class="menu-child-info">
                        <div class="child-name-gold">{{ child.name }}</div>
                        <span style="font-size:0.75rem; color:#64748b;">ID: {{ child.pairing_code }}</span>
                        
                        <div class="status-row">
                            <div class="dist-badge" id="dist-{{ child.id }}">
                                <i class="fa-solid fa-location-arrow"></i> Finding...
                            </div>
                            <div class="bat-badge {{ 'bat-low' if (child.last_battery is none or child.last_battery < 20) else 'bat-high' }}" id="bat-{{ child.id }}">
                                <i class="fa-solid fa-battery-full"></i> {{ child.last_battery or 0 }}%
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="text-align:center; color:#94a3b8; padding:20px;">No children connected.</p>
            {% endif %}

            <div style="padding: 15px; border-top: 1px solid #eee; background: white;">
                <form action="{{ url_for('add_child') }}" method="POST">
                    <input type="text" name="child_name" placeholder="Child Name" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;" required>
                    <button type="submit" style="width: 100%; padding: 12px; background: #1877F2; color: white; border: none; border-radius: 8px; font-weight: 600;"><i class="fa-solid fa-plus"></i> Add Child</button>
                </form>
            </div>
        </div>

        <a href="{{ url_for('logout') }}" style="padding: 15px; color: #dc2626; text-align: center; font-weight: bold; text-decoration: none; border-top: 1px solid #eee; display: block;">Logout</a>
    </div>

    <div class="map-wrapper"><div id="map"></div></div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="location.reload()"><i class="fa-solid fa-map-location-dot"></i></div>
        <div class="nav-item" onclick="window.location.href='{{ url_for('geofence_page') }}'"><i class="fa-solid fa-shield-halved"></i></div>
        <div class="nav-item" onclick="toggleMenu()"><i class="fa-solid fa-gear"></i></div>
    </div>

    <form id="profileForm" action="{{ url_for('upload_profile_pic') }}" method="POST" enctype="multipart/form-data">
        <input type="file" name="profile_pic" id="parent_file_input" accept="image/*" onchange="document.getElementById('profileForm').submit()">
    </form>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        var map = L.map('map', { zoomControl: false }).setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', { maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3'] }).addTo(map);

        var markers = {}; var polylines = {}; var parentMarker = null; 
        var parentLat = null, parentLng = null;
        var siren = new Audio('https://www.soundjay.com/buttons/sounds/alarm-siren-01.mp3');

        function toggleMenu() { document.getElementById('sideMenu').classList.toggle('open'); }
        document.getElementById('map').onclick = function() { document.getElementById('sideMenu').classList.remove('open'); }
        function dismissSOS() { document.getElementById('sos-overlay').style.display = 'none'; siren.pause(); siren.currentTime = 0; }

        function showToast(msg) {
            var x = document.getElementById("toast");
            x.innerText = msg;
            x.className = "show";
            setTimeout(function(){ x.className = x.className.replace("show", ""); }, 3000);
        }

        function locateChild(lat, lng) {
            if (lat && lat !== 'None' && lat !== 'null') { 
                map.setView([lat, lng], 18); 
                toggleMenu(); 
            } else { 
                showToast("âš ï¸ Location not updated yet."); 
            }
        }

        // Parent GPS Logic
        function updateParentLocation() {
            if (navigator.geolocation) {
                console.log("Requesting GPS...");
                navigator.geolocation.watchPosition(position => {
                    parentLat = position.coords.latitude;
                    parentLng = position.coords.longitude;
                    
                    if (parentMarker) {
                        parentMarker.setLatLng([parentLat, parentLng]);
                    } else {
                        var icon = L.divIcon({ className: 'p-div', html: '<div class="parent-dot"></div>', iconSize: [18, 18] });
                        parentMarker = L.marker([parentLat, parentLng], {icon: icon}).addTo(map);
                        map.setView([parentLat, parentLng], 15);
                        showToast("âœ… Parent GPS Locked");
                    }
                }, err => {
                    console.log("GPS Error", err);
                    showToast("âš ï¸ Turn on GPS/Location for Line");
                }, { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 });
            } else {
                showToast("GPS not supported");
            }
        }
        updateParentLocation();

        function updateData() {
            fetch('/api/get_children_data')
                .then(res => res.json())
                .then(data => {
                    data.children.forEach(child => {
                        // Battery Update
                        var batElem = document.getElementById('bat-' + child.id);
                        if(batElem) {
                            batElem.innerHTML = `<i class="fa-solid fa-battery-full"></i> ${child.last_battery or 0}%`;
                            batElem.className = (child.last_battery < 20) ? "bat-badge bat-low" : "bat-badge bat-high";
                        }

                        // SOS Logic
                        if (child.is_sos) {
                            var overlay = document.getElementById('sos-overlay');
                            if (overlay.style.display !== 'flex') {
                                overlay.style.display = 'flex';
                                document.getElementById('sos-text').innerText = child.name + " needs help!";
                                siren.play().catch(e => console.log(e));
                            }
                        }

                        // Map & Distance Logic
                        if (child.last_latitude && child.last_latitude !== 'None') {
                            var lat = parseFloat(child.last_latitude);
                            var lng = parseFloat(child.last_longitude);
                            
                            var icon = L.divIcon({
                                className: 'custom-div',
                                html: `<img src="${child.profile_pic || '/static/default-profile.png'}" class="child-marker-icon">`,
                                iconSize: [45, 45], iconAnchor: [22, 22]
                            });

                            if (markers[child.id]) markers[child.id].setLatLng([lat, lng]);
                            else markers[child.id] = L.marker([lat, lng], {icon: icon}).addTo(map);

                            // BLUE LINE
                            if (parentLat && parentLng) {
                                if (polylines[child.id]) map.removeLayer(polylines[child.id]);
                                polylines[child.id] = L.polyline(
                                    [[parentLat, parentLng], [lat, lng]], 
                                    { color: '#1877F2', weight: 3, opacity: 0.8, dashArray: '10, 10' }
                                ).addTo(map);
                                
                                var p1 = L.latLng(parentLat, parentLng);
                                var p2 = L.latLng(lat, lng);
                                var d = p1.distanceTo(p2); 
                                
                                var distText = d < 1000 ? Math.round(d) + " m" : (d/1000).toFixed(1) + " km";
                                var distElem = document.getElementById('dist-' + child.id);
                                if(distElem) distElem.innerHTML = `<i class="fa-solid fa-location-arrow"></i> ${distText}`;
                            }
                        }
                    });
                });
        }
        setInterval(updateData, 4000);
        updateData();
    </script>
</body>
</html>

