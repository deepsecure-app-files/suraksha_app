<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Suraksha OneView</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <link rel="preload" as="image" href="{{ profile_pic_url or url_for('static', filename='default-profile.png') }}">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap');

        * { 
            margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; 
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }
        
        input, textarea { -webkit-user-select: text !important; user-select: text !important; }

        html, body { 
            background-color: #f0f2f5; 
            height: 100%; width: 100%;
            display: flex; flex-direction: column;
            overflow: hidden; position: fixed;
        }

        /* --- 1. HEADER (Facebook Style - Clean & Solid) --- */
        .header {
            background: #141e30; /* Child Dashboard ‡§ú‡•à‡§∏‡§æ ‡§°‡§æ‡§∞‡•ç‡§ï ‡§•‡•Ä‡§Æ */
            padding: 10px 15px;
            display: flex;
            justify-content: space-between; /* Left: Pic, Center: Brand, Right: Menu */
            align-items: center;
            height: 70px;
            z-index: 2001;
            flex-shrink: 0;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        /* üî• ‡§∏‡•Å‡§ß‡§æ‡§∞ 1: ‡§™‡•ç‡§∞‡•ã‡§´‡§æ‡§á‡§≤ ‡§™‡§ø‡§ï ‡§¨‡§æ‡§à‡§Ç ‡§§‡§∞‡§´ (Left), ‡§¨‡§°‡§º‡•Ä ‡§î‡§∞ ‡§®‡•Ä‡§≤‡•Ä ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ */
        .header-left {
            display: flex; align-items: center;
            flex: 1; /* ‡§ú‡§ó‡§π ‡§≤‡•á‡§ó‡§æ */
        }
        .parent-img-large {
            width: 50px; height: 50px; /* ‡§´‡•ã‡§ü‡•ã ‡§¨‡§°‡§º‡•Ä ‡§ï‡•Ä */
            border-radius: 50%;
            border: 3px solid #1877F2; /* üî• ‡§®‡•Ä‡§≤‡§æ ‡§¨‡•â‡§∞‡•ç‡§°‡§∞ (Facebook Blue) */
            object-fit: cover;
            background-color: #fff;
            cursor: pointer;
        }

        /* üî• ‡§∏‡•Å‡§ß‡§æ‡§∞ 2: ‡§¨‡•ç‡§∞‡§æ‡§Ç‡§° ‡§®‡§æ‡§Æ ‡§¨‡•Ä‡§ö ‡§Æ‡•á‡§Ç ‡§î‡§∞ ‡§∏‡•Å‡§®‡§π‡§∞‡§æ */
        .app-brand {
            font-size: 1.6rem;
            font-weight: 800;
            background: linear-gradient(to right, #FFD700, #FFA500);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-align: center;
            flex: 1; /* ‡§∏‡•á‡§Ç‡§ü‡§∞ ‡§Æ‡•á‡§Ç ‡§∞‡§ñ‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è */
        }

        /* ‡§Æ‡•á‡§®‡•Ç ‡§¨‡§ü‡§® ‡§¶‡§æ‡§à‡§Ç ‡§§‡§∞‡§´ */
        .header-right {
            flex: 1; display: flex; justify-content: flex-end;
        }
        .menu-btn { color: white; font-size: 1.5rem; cursor: pointer; padding: 5px; }

        /* --- 2. SIDE MENU --- */
        .side-menu {
            position: absolute; top: 0; left: -300px; width: 280px; height: 100%;
            background: white; transition: 0.3s ease-in-out; 
            z-index: 3000; display: flex; flex-direction: column;
            box-shadow: 10px 0 20px rgba(0,0,0,0.3);
        }
        .side-menu.open { left: 0; }
        
        .menu-header { 
            background: #141e30; padding: 30px 20px; color: white; 
        }
        .menu-user-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; }

        .children-section { flex: 1; overflow-y: auto; padding: 0; background: #fff; }
        .section-label { padding: 15px 20px 5px; font-size: 0.8rem; font-weight: 700; color: #64748b; text-transform: uppercase; }

        .menu-child-card {
            padding: 15px 20px; border-bottom: 1px solid #f1f5f9;
            display: flex; align-items: center; gap: 12px; cursor: pointer;
        }
        .menu-child-card:active { background: #f8fafc; }
        .menu-child-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 2px solid #e2e8f0; }
        .menu-child-info h4 { font-size: 0.95rem; color: #0f172a; margin: 0; }
        .menu-child-status { font-size: 0.75rem; color: #64748b; }
        
        .add-child-box { padding: 15px; border-top: 1px solid #eee; background: #f8f9fa; }
        .add-child-btn {
            width: 100%; padding: 12px; background: #1877F2; color: white; border: none;
            border-radius: 8px; font-weight: 600; cursor: pointer;
        }
        .logout-btn { padding: 15px; color: #dc2626; text-align: center; font-weight: bold; text-decoration: none; border-top: 1px solid #eee; display: block;}

        /* --- 3. MAP WRAPPER (No Shadow, Full Space) --- */
        .map-wrapper {
            flex: 1; 
            position: relative; 
            width: 100%;
            margin-bottom: 60px; /* ‡§®‡•Ä‡§ö‡•á ‡§¨‡§ü‡§® ‡§ï‡•á ‡§≤‡§ø‡§è ‡§ú‡§ó‡§π */
            background: #e5e7eb;
            /* üî• ‡§∏‡•Å‡§ß‡§æ‡§∞ 3: ‡§õ‡§æ‡§Ø‡§æ ‡§π‡§ü‡§æ‡§à */
        }
        #map { width: 100%; height: 100%; }

        /* --- 4. BOTTOM NAV (Fixed - Not Floating) --- */
        .bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 60px;
            background: white; 
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #ddd; /* ‡§∏‡§æ‡§´ ‡§≤‡§æ‡§á‡§® */
            z-index: 2000;
            /* ‡§π‡§µ‡§æ ‡§Æ‡•á‡§Ç ‡§®‡§π‡•Ä‡§Ç, ‡§®‡•Ä‡§ö‡•á ‡§ö‡§ø‡§™‡§ï‡§æ ‡§π‡•Å‡§Ü */
        }
        .nav-item { 
            color: #94a3b8; font-size: 1.4rem; position: relative; 
            height: 100%; width: 100%; display: flex; align-items: center; justify-content: center;
        }
        .nav-item.active { color: #1877F2; }
        .nav-item.active::after {
            content: ''; position: absolute; top: 0; left: 50%; transform: translateX(-50%);
            width: 40px; height: 3px; background: #1877F2; border-bottom-left-radius: 4px; border-bottom-right-radius: 4px;
        }

        /* SOS Alert Overlay */
        #sos-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(220, 38, 38, 0.95); z-index: 9999;
            flex-direction: column; align-items: center; justify-content: center; color: white;
            text-align: center; padding: 20px;
        }
        .sos-btn-stop { background: white; color: #dc2626; padding: 15px 40px; border-radius: 50px; border: none; font-weight: bold; font-size: 1.2rem; margin-top: 30px; }

        /* Hidden Input */
        #parent_file_input { display: none; }
        
        /* Map Markers */
        .child-marker-icon { width: 45px; height: 45px; border-radius: 50%; border: 3px solid white; box-shadow: 0 3px 10px rgba(0,0,0,0.4); object-fit: cover; background: #fff;}
        .parent-dot { width: 16px; height: 16px; background: #1877F2; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 10px rgba(24, 119, 242, 0.5); }
    </style>
</head>
<body>

    <div id="sos-overlay">
        <i class="fa-solid fa-triangle-exclamation" style="font-size: 5rem; animation: pulse 0.5s infinite;"></i>
        <h1 style="font-size: 2.5rem; margin-top: 20px;">SOS ALERT!</h1>
        <p id="sos-text" style="font-size: 1.2rem;">Emergency reported.</p>
        <button class="sos-btn-stop" onclick="dismissSOS()">I AM SAFE</button>
    </div>

    <div class="header">
        <div class="header-left" onclick="document.getElementById('parent_file_input').click()">
            <img src="{{ profile_pic_url or url_for('static', filename='default-profile.png') }}" class="parent-img-large">
        </div>
        
        <div class="app-brand">suraksha</div>

        <div class="header-right">
            <i class="fa-solid fa-bars menu-btn" onclick="toggleMenu()"></i>
        </div>
    </div>

    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="menu-user-name">Hello, {{ username }}</div>
            <div style="font-size:0.85rem; opacity:0.8;">Parent Account</div>
        </div>

        <div class="children-section">
            <div class="section-label">Track Children</div>
            
            {% if children %}
                {% for child in children %}
                <div class="menu-child-card" onclick="locateChild('{{ child.last_latitude }}', '{{ child.last_longitude }}')">
                    <img src="{{ child.profile_pic if child.profile_pic else url_for('static', filename='default-profile.png') }}" class="menu-child-img">
                    <div class="menu-child-info">
                        <h4>{{ child.name }}</h4>
                        <div class="menu-child-status" id="status-{{ child.id }}">Offline</div>
                    </div>
                </div>
                {% endfor %}
            {% else %}
                <p style="text-align:center; color:#94a3b8; padding:20px;">No children connected.</p>
            {% endif %}

            <div class="add-child-box">
                <form action="{{ url_for('add_child') }}" method="POST">
                    <input type="text" name="child_name" placeholder="Child Name" style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:5px;" required>
                    <button type="submit" class="add-child-btn"><i class="fa-solid fa-plus"></i> Add Child</button>
                </form>
            </div>
        </div>

        <a href="{{ url_for('logout') }}" class="logout-btn">Logout</a>
    </div>

    <div class="map-wrapper">
        <div id="map"></div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="location.reload()"><i class="fa-solid fa-map-location-dot"></i></div>
        <div class="nav-item" onclick="window.location.href='{{ url_for('geofence_page') }}'"><i class="fa-solid fa-shield-halved"></i></div>
        <div class="nav-item" onclick="toggleMenu()"><i class="fa-solid fa-gear"></i></div>
    </div>

    <form id="profileForm" action="{{ url_for('upload_profile_pic') }}" method="POST" enctype="multipart/form-data">
        <input type="file" name="profile_pic" id="parent_file_input" accept="image/*" onchange="document.getElementById('profileForm').submit()">
    </form>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // --- Full Functionality (No Cuts) ---
        var map = L.map('map', { zoomControl: false }).setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.google.com/vt/lyrs=m&x={x}&y={y}&z={z}', {
            maxZoom: 20, subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map);

        var markers = {};
        var parentMarker = null;
        var siren = new Audio('https://www.soundjay.com/buttons/sounds/alarm-siren-01.mp3');

        function toggleMenu() {
            document.getElementById('sideMenu').classList.toggle('open');
        }

        document.getElementById('map').onclick = function() {
            document.getElementById('sideMenu').classList.remove('open');
        }

        function locateChild(lat, lng) {
            if (lat && lat !== 'None') {
                map.setView([lat, lng], 18);
                toggleMenu(); 
            } else {
                alert("Location not available yet.");
            }
        }

        function dismissSOS() {
            document.getElementById('sos-overlay').style.display = 'none';
            siren.pause();
            siren.currentTime = 0;
        }

        // Update Logic
        function updateData() {
            // 1. Parent Location
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(position => {
                    var lat = position.coords.latitude;
                    var lng = position.coords.longitude;
                    if (parentMarker) parentMarker.setLatLng([lat, lng]);
                    else {
                        var icon = L.divIcon({ className: 'p-div', html: '<div class="parent-dot"></div>', iconSize: [16, 16] });
                        parentMarker = L.marker([lat, lng], {icon: icon}).addTo(map);
                    }
                }, err => {}, {enableHighAccuracy:true});
            }

            // 2. Children Data
            fetch('/api/get_children_data')
                .then(res => res.json())
                .then(data => {
                    data.children.forEach(child => {
                        if (child.last_latitude) {
                            var lat = child.last_latitude;
                            var lng = child.last_longitude;

                            var icon = L.divIcon({
                                className: 'custom-div',
                                html: `<img src="${child.profile_pic || '/static/default-profile.png'}" class="child-marker-icon">`,
                                iconSize: [45, 45], iconAnchor: [22, 22]
                            });

                            if (markers[child.id]) {
                                markers[child.id].setLatLng([lat, lng]);
                            } else {
                                markers[child.id] = L.marker([lat, lng], {icon: icon}).addTo(map);
                            }

                            // Check SOS
                            if (child.is_sos) {
                                var overlay = document.getElementById('sos-overlay');
                                if (overlay.style.display !== 'flex') {
                                    overlay.style.display = 'flex';
                                    document.getElementById('sos-text').innerText = child.name + " needs help!";
                                    siren.play().catch(e => console.log(e));
                                }
                            }
                            
                            var st = document.getElementById('status-' + child.id);
                            if(st) st.innerText = "Active";
                        }
                    });
                });
        }
        
        setInterval(updateData, 5000);
        updateData();
    </script>
</body>
</html>

